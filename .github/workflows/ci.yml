name: Provision S3 via EC2 Terraform
#
on:
  push:
    branches:
      - main   # ðŸ‘ˆ runs automatically on every commit to main
  workflow_dispatch:
    inputs:
      confirm_apply:
        description: "Do you want to apply Terraform changes? (yes/no)"
        required: true
        default: "yes"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/thanos.pem
          chmod 600 ~/.ssh/thanos.pem

      - name: Run Terraform on EC2
        env:
          # ðŸ‘‡ Default "yes" if input not provided (push event)
          CONFIRM_APPLY: ${{ github.event.inputs.confirm_apply || 'yes' }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/thanos.pem ec2-user@${{ secrets.EC2_HOST }} << EOF
            set -e

            rm -rf ~/terra_lint
            git clone https://github.com/megha-1299/terra_lint.git
            cd terra_lint/Configuration

            echo "ðŸ“Œ Running terraform init..."
            terraform init -input=false

            echo "ðŸ“Œ Running terraform plan..."
            terraform plan -out=tfplan -input=false

            if [ "$CONFIRM_APPLY" = "yes" ]; then
              echo "âœ… Applying Terraform changes..."
              terraform apply -input=false -auto-approve tfplan
            else
              echo "âŒ Skipping terraform apply (confirmation not given)"
            fi
          EOF

# name: Destroy S3 via EC2 Terraform

# on:
#   push:
#     branches:
#       - main   # ðŸ‘ˆ runs automatically on every commit to main
#   workflow_dispatch:
#     inputs:
#       confirm_destroy:
#         description: "Do you want to destroy Terraform resources? (yes/no)"
#         required: true
#         default: "yes"

# jobs:
#   destroy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Setup SSH Key
#         run: |
#           mkdir -p ~/.ssh
#           echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/thanos.pem
#           chmod 600 ~/.ssh/thanos.pem

#       - name: Run Terraform Destroy on EC2
#         env:
#           CONFIRM_DESTROY: ${{ github.event.inputs.confirm_destroy || 'yes' }}
#         run: |
#           ssh -o StrictHostKeyChecking=no -i ~/.ssh/thanos.pem ec2-user@${{ secrets.EC2_HOST }} << EOF
#             set -e

#             rm -rf ~/Terragit
#             git clone https://github.com/Fardeen313/Terragit.git
#             cd Terragit/S3_Bucket

#             echo "ðŸ“Œ Running terraform init..."
#             terraform init -input=false

#             echo "ðŸ“Œ Running terraform plan -destroy..."
#             terraform plan -destroy -out=tfplan -input=false

#             if [ "$CONFIRM_DESTROY" = "yes" ]; then
#               echo "ðŸ”¥ Destroying Terraform resources..."
#               terraform apply -input=false -auto-approve tfplan
#             else
#               echo "âŒ Skipping terraform destroy (confirmation not given)"
#             fi
#           EOF
